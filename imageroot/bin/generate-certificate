#!/bin/bash

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#
HOST=$1

mkdir -vp certificates

cd certificates

certtmp="NethServer.pem"
keytmp="NethServer.key"
csrtmp="NethServer.csr"
dhtmp="dh.pem"

# generate dhparam, the dsaparam makes it fast
umask 0077
dhtmp=$(mktemp dh.pem.XXXXXX)
trap 'rm -f ${dhtmp}' EXIT
openssl dhparam -dsaparam -out "${dhtmp}" 2048

# we request csr
openssl req -nodes -newkey rsa:2048 \
    -keyout ${keytmp} \
    -out ${csrtmp} -new  \
    -subj "/C=IT/ST=Italy/L=Pesaro/O=Nethesis/OU=NethVoice/CN=${HOST}/subjectAltName=cti.${HOST},nethvoice.${HOST},${HOST}"

# we selfsign the certificate
openssl x509 -req -sha256 -days 3650 \
    -in ${csrtmp} \
    -signkey ${keytmp} \
    -out ${certtmp}

# required by nethcti-server
cp ${certtmp} "NethServer.crt"

# required by asterisk
mkdir -p integration/
chmod a+rx integration
cat ${keytmp} ${certtmp} > integration/certificate.pem
cat ${keytmp} > integration/webserver.key
cat ${certtmp} > integration/webserver.crt
chmod a+r integration/*

# required by flexisip
cat ${keytmp} ${certtmp} > agent.pem
cat ${certtmp} > cafile.pem
