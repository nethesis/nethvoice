#!/bin/bash

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

set -e

if [[ -z "$NETHVOICE_HOST" ]]; then
    exit 3 # Module is not fully configured, abort execution.
fi

mkdir -vp "$AGENT_STATE_DIR/certificates/"

umask 0077

# Override redis-exec "privileged=True"
export REDIS_USER=default

traefik_instance=$(redis-exec GET "node/${NODE_ID}/default_instance/traefik")

if [ "0" = "$(redis-exec EXISTS "module/$traefik_instance/certificate/$NETHVOICE_HOST")" ]; then
    echo "Certificate for $NETHVOICE_HOST is missing."
    exit 4
fi

redis-exec HGET "module/$traefik_instance/certificate/$NETHVOICE_HOST" key | base64 -d > "certificates/$NETHVOICE_HOST.key"
redis-exec HGET "module/$traefik_instance/certificate/$NETHVOICE_HOST" cert | base64 -d > "certificates/$NETHVOICE_HOST.crt"

cat "certificates/$NETHVOICE_HOST.key" "certificates/$NETHVOICE_HOST.crt" > "certificates/$NETHVOICE_HOST.pem"

# generate certs for flexisip
mkdir -p certificates/flexisip
awk -v RS= '{print > ("certificates/flexisip/chain-" NR ".crt")}' "certificates/${NETHVOICE_HOST}.crt"
cat "certificates/${NETHVOICE_HOST}.key" certificates/flexisip/chain-1.crt > certificates/flexisip/agent.pem
rm certificates/flexisip/chain-1.crt
cat certificates/flexisip/chain-*.crt > certificates/flexisip/cafile.pem
rm -rf certificates/flexisip/chain-*.crt
